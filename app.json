[{"name":"app.R","content":"library(shiny)\noptions(shiny.maxRequestSize = 100 * 1024^2)\n\nui <- fluidPage(\n  titlePanel(\n    div(HTML(\"Appendix of <em>Simultaneous estimation and model choice for \n             big discrete time-to-event data with additive predictors<\/em>\"))\n  ),\n  \n  sidebarLayout(\n    sidebarPanel(\n      ## file upload\n      fileInput(\"rdsfile\", \"Upload bb4sa_sim_results.rds\"),\n      \n      ## model selection\n      selectInput(\"model\", \"Model:\", \n                  choices = list(\n                    'GLM' = 'glm',\n                    'BAM' = 'bam',\n                    'BBFIT' = 'bbfit'\n                  ), \n                  selected = 'bbfit'),\n      \n      ## variable selection\n      selectInput(\"variable\", \"Variable:\", \n                  choices = list(\n                    'Baseline' = 't',\n                    'Linear' = 'x1',\n                    'Sinus' = 'x2',\n                    'Squared' = 'x3',\n                    'Complex' = 'x4',\n                    'Noise 1' = 'n1',\n                    'Noise 2' = 'n2',\n                    'Noise 3' = 'n3',\n                    'Noise 4' = 'n4',\n                    'Noise 5' = 'n5',\n                    'Noise 6' = 'n6'\n                  ),\n                  selected = 't'),\n      \n      ## number of individuals selection\n      selectInput(\"numindividuals\", \"Number of individuals:\", \n                  choices = list(\n                    '1000' = '1000', \n                    '5000 (basic setting)' = '5000', \n                    '10000' = '10000', \n                    '50000' = '50000', \n                    '100000' = '100000', \n                    '500000' = '500000', \n                    '1000000' = '1000000'), \n                  selected = '5000'),\n      \n      ## baseline hazard selection\n      selectInput(\"bali\", \"Baseline hazard specification:\", \n                  choices = list(\n                    'a = -3 (basic setting)' = '2',\n                    'a = -2' = '1',\n                    'a = -4' = '3'\n                  ),\n                  selected = '2'),\n      \n      ## sd selection\n      selectInput(\"setsd\", \"Standard deviation scaling:\", \n                  choices = list(\n                    'SD = 1 (basic setting)' = '1',\n                    'SD = 0.5' = '0.5',\n                    'SD = 2' = '2'\n                  ),\n                  selected = '1'),\n      \n      ## plot specs\n      selectInput(\"plottype\", \"Plotting option:\",\n                  choices = c(\"Overlay\", \"Separate\"),\n                  selected = \"Overlay\"),\n      numericInput(\"wait\", \"Wait:\", value = 0.1, min = 0.1, max = 2, step = 0.1), ######## change value to 1 after testing\n      conditionalPanel(\n        condition = \"input.plottype == 'Separate'\",\n        checkboxInput(\"plotspecrep\", \"Plot specific replication\", value = FALSE),\n      ),\n      conditionalPanel(\n        condition = \"input.plottype == 'Separate' && input.plotspecrep == true\",\n        numericInput(\"specrep\", \"Replication:\", \n                     value = 100, min = 1, max = 250, step = 1),\n      ),\n      conditionalPanel(\n        condition = \"input.plottype == 'Overlay'\",\n        checkboxInput(\"plotmean\", \"Plot mean\", value = TRUE),\n        checkboxInput(\"plotquants\", \"Plot quantiles\", value = TRUE),\n      ),\n      checkboxInput(\"plottrue\", \"Plot true/zero line\", value = TRUE),\n      checkboxInput(\"customy\", \"Custom Y-axis limits\", value = TRUE),\n      conditionalPanel(\n        condition = \"input.customy == true\",\n        numericInput(\"ymin\", \"Y-axis min:\", value = -2, step = 0.2),\n        numericInput(\"ymax\", \"Y-axis max:\", value = 2, step = 0.2)\n      ),\n      \n      ## start plot button\n      actionButton(\"startplot\", \"Plot\")\n      ),\n    \n    mainPanel(\n      plotOutput(\"ploteffect\", height = \"380px\"),\n      plotOutput(\"plotbias\", height = \"380px\")\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n  \n  ## define stuff\n  maxiter <- 250\n  fbl1 <- function(t) -2 - 0.5*log(t)\n  fbl2 <- function(t) -3 - 0.5*log(t)\n  fbl3 <- function(t) -4 - 0.5*log(t)\n  fx1 <- function(x1) 0.5*x1\n  fx2 <- function(x2) 1.5*sin(x2)\n  fx3 <- function(x3) x3^2/6 - 1.5\n  fx4 <- function(x4) sin(2*(4*x4-2))+2*exp(-(16^2)*(x4-0.5)^2)\n  trans2sd <- function(x, sd = 1) (sd*x)/sd(unique(x))\n  demean <- function(x) x-mean(x)\n  coleffects <- c(hcl.colors(8, \"YlGnBu\")[2], hcl.colors(8, \"YlOrRd\")[2])\n  names(coleffects) <- c('true', 'esti')\n  \n  ## data\n  datall <- reactive({\n    req(input$rdsfile)\n    readRDS(input$rdsfile$datapath)\n  })\n\n  ## rvs\n  rv <- reactiveValues(i = 0, stop = FALSE, \n                       eff = list(), bias = list())\n  \n  ## plot effect\n  output$ploteffect <- renderPlot({\n    if (rv$i > 0 & !rv$stop) {\n      ## rep to 3 digit number, e.g. 1 -> 001\n      if(input$plotspecrep) {\n        rc <- sprintf(\"%03d\", input$specrep)\n      } else {rc <- sprintf(\"%03d\", rv$i)}\n      \n      ## ind and file path\n      ind <- as.character(input$numindividuals)\n      bali <- as.integer(input$bali)\n      setsd <- as.numeric(input$setsd)\n      \n      fi <- paste0('sim_ind_', ind,\n                   '_bali_', bali,\n                   '_spaeff_FALSE_setsd_', setsd,\n                   '_mod_', input$model,\n                   '_rep_', rc)\n      \n      ## check if file exists and if true plot\n      if(!is.null(datall()[[fi]])) {\n        ## read and subset\n        dat <- datall()[[fi]]\n        y <- dat$pred.eff[[input$variable]]\n        \n        ## save esti effects of previous reps\n        rv$eff[[rv$i]] <- y\n        \n        ## matching x\n        x <- if (input$variable == 't') {\n          seq(1, 20, length.out = 100)\n        } else if (input$variable == 'x4') {\n          seq(0, 1, length.out = 100)\n        } else {\n          seq(-3, 3, length.out = 100)\n        }\n        \n        ## true effect\n        if(input$variable == 't' & bali == 1) yt <- demean(fbl1(x))\n        if(input$variable == 't' & bali == 2) yt <- demean(fbl2(x))\n        if(input$variable == 't' & bali == 3) yt <- demean(fbl3(x))\n        if(input$variable == 'x1') yt <- demean(trans2sd(fx1(x), setsd))\n        if(input$variable == 'x2') yt <- demean(trans2sd(fx2(x), setsd))\n        if(input$variable == 'x3') yt <- demean(trans2sd(fx3(x), setsd))\n        if(input$variable == 'x4') yt <- demean(trans2sd(fx4(x), setsd))\n        if(input$variable %in% paste0('n', 1:6)) yt <- rep(0, 100)\n        \n        ## custom y limits\n        ylimits <- if(input$customy) {\n          c(input$ymin, input$ymax)\n        } else {c(min(y, yt), max(y, yt))}\n        \n        ## define info for legend\n        le <- list()\n        le$le <- c(paste0(\"Estimated (Rep.: \", rv$i, \")\"), \n                   paste0(\"Estimated (Rep.: \", ifelse(rv$i == 1, \"-\", paste0('1-',rv$i-1)), \")\"),\n                   \"Mean of estimated\",\n                   \"Q2.5/97.5 of estimated\",\n                   \"True\")\n        le$lt <- c(1, 1, 1, 2, 1)\n        le$co <- c('black', 'lightgrey', \n                   coleffects[['esti']], coleffects[['esti']], \n                   coleffects[['true']])\n        \n        ## plot par\n        par(mar = c(2.1, 2.1, 2.1, 1.1), oma = c(0, 0, 0, 11))\n        \n        ## plot estimated effects separate or as overlay\n        if (input$plottype == 'Separate' | (input$plottype == 'Separate' & input$plotspecrep)) {\n          plot(x, y, type = \"l\", ylim = ylimits,\n               xlab = NA, ylab = NA)\n          le$i <- 1\n          \n        } else if(input$plottype == 'Overlay') {\n          if(rv$i == 1) {\n            plot(x, y, type = \"l\", ylim = ylimits,\n                 xlab = NA, ylab = NA)\n          } else {\n            plot(x, rv$eff[[1]], type = \"n\", ylim = ylimits, \n                 xlab = NA, ylab = NA, col = 'lightgrey')\n            for(i in 2:(rv$i-1)) {\n              lines(x, rv$eff[[i]], col = 'lightgrey')\n            }\n            lines(x, y)\n          }\n          le$i <- 1:2\n          \n          ## plot mean of reps 1-current rep\n          if(input$plotmean) {\n            lines(x, apply(do.call(cbind, rv$eff), 1, mean), \n                  col = coleffects[['esti']], lty = 1, lwd = 2)\n            le$i <- 1:3\n          }\n          if(input$plotquants) {\n            lines(x, apply(do.call(cbind, rv$eff), 1, FUN = function(x) quantile(x, probs = 0.025)), \n                  col = coleffects[['esti']], lty = 2, lwd = 2)\n            lines(x, apply(do.call(cbind, rv$eff), 1, FUN = function(x) quantile(x, probs = 0.975)), \n                  col = coleffects[['esti']], lty = 2, lwd = 2)\n            le$i <- 1:4\n          }\n        }\n        \n        ## plot true effect\n        if(input$plottrue) {\n          lines(x, yt, col = coleffects[['true']], \n                lty = 1, lwd = 2)\n          le$i <- c(le$i, 5)\n        }\n        \n        ## plot adjusted legend\n        legend(par('usr')[2], par('usr')[4], \n               bty = 'n', xpd = NA,\n               legend = le$le[le$i], \n               lty = le$lt[le$i], \n               col = le$co[le$i])\n        \n        ## add some info to plot\n        mtext('Effects', side = 3, adj = 0, line = 0.5, cex = 1.2)\n        \n      } else {\n        ## if file not found plot text that says that file not found\n        ## or setting is not available\n        plot.new()\n        text(0.5, 0.5, 'File not found/setting not avaliable!', cex = 1.5)\n        text(0.5, 0.4, paste0('File: ', fi), cex = 0.9)\n      }\n    } else {\n      ## if settings change, press button to start plotting\n      plot.new()\n      text(0.5, 0.5, 'Press \"Plot\" to start plotting.', cex = 1.5)\n    }\n  })\n  \n  ## plot bias\n  output$plotbias <- renderPlot({\n    if (rv$i > 0 & !rv$stop) {\n      ## rep to 3 digit number, e.g. 1 -> 001\n      if(input$plotspecrep) {\n        rc <- sprintf(\"%03d\", input$specrep)\n      } else {rc <- sprintf(\"%03d\", rv$i)}\n\n      ## ind and file path\n      ind <- as.character(input$numindividuals)\n      bali <- as.integer(input$bali)\n      setsd <- as.numeric(input$setsd)\n\n      fi <- paste0('sim_ind_', ind,\n                   '_bali_', bali,\n                   '_spaeff_FALSE_setsd_', setsd,\n                   '_mod_', input$model,\n                   '_rep_', rc)\n\n      ## check if file exists and if true plot\n      if(!is.null(datall()[[fi]])) {\n        ## read and subset\n        dat <- datall()[[fi]]\n        y <- dat$pred.eff.bias[[input$variable]]\n\n        ## save esti effects of previous reps\n        rv$bias[[rv$i]] <- y\n\n        ## matching x\n        x <- if (input$variable == 't') {\n          seq(1, 20, length.out = 100)\n        } else if (input$variable == 'x4') {\n          seq(0, 1, length.out = 100)\n        } else {\n          seq(-3, 3, length.out = 100)\n        }\n\n        ## zero line\n        yt <- rep(0, 100)\n\n        ## custom y limits\n        ylimits <- if(input$customy) {\n          c(input$ymin, input$ymax)\n        } else {c(min(y, yt), max(y, yt))}\n\n        ## define info for legend\n        le <- list()\n        le$le <- c(paste0(\"Estimated (Rep.: \", rv$i, \")\"),\n                   paste0(\"Estimated (Rep.: \", ifelse(rv$i == 1, \"-\", paste0('1-',rv$i-1)), \")\"),\n                   \"Mean of estimated\",\n                   \"Q2.5/97.5 of estimated\",\n                   \"Zero line\")\n        le$lt <- c(1, 1, 1, 2, 1)\n        le$co <- c('black', 'lightgrey',\n                   coleffects[['esti']], coleffects[['esti']],\n                   coleffects[['true']])\n\n        ## plot par\n        par(mar = c(2.1, 2.1, 2.1, 1.1), oma = c(0, 0, 0, 11))\n\n        ## plot estimated effects separate or as overlay\n        if (input$plottype == 'Separate' | (input$plottype == 'Separate' & input$plotspecrep)) {\n          plot(x, y, type = \"l\", ylim = ylimits,\n               xlab = NA, ylab = NA)\n          le$i <- 1\n\n        } else if(input$plottype == 'Overlay') {\n          if(rv$i == 1) {\n            plot(x, y, type = \"l\", ylim = ylimits,\n                 xlab = NA, ylab = NA)\n          } else {\n            plot(x, rv$bias[[1]], type = \"n\", ylim = ylimits,\n                 xlab = NA, ylab = NA, col = 'lightgrey')\n            for(i in 2:(rv$i-1)) {\n              lines(x, rv$bias[[i]], col = 'lightgrey')\n            }\n            lines(x, y)\n          }\n          le$i <- 1:2\n\n          ## plot mean of reps 1-current rep\n          if(input$plotmean) {\n            lines(x, apply(do.call(cbind, rv$bias), 1, mean),\n                  col = coleffects[['esti']], lty = 1, lwd = 2)\n            le$i <- 1:3\n          }\n          if(input$plotquants) {\n            lines(x, apply(do.call(cbind, rv$bias), 1, FUN = function(x) quantile(x, probs = 0.025)),\n                  col = coleffects[['esti']], lty = 2, lwd = 2)\n            lines(x, apply(do.call(cbind, rv$bias), 1, FUN = function(x) quantile(x, probs = 0.975)),\n                  col = coleffects[['esti']], lty = 2, lwd = 2)\n            le$i <- 1:4\n          }\n        }\n\n        ## plot true effect\n        if(input$plottrue) {\n          lines(x, yt, col = coleffects[['true']],\n                lty = 1, lwd = 2)\n          le$i <- c(le$i, 5)\n        }\n\n        ## plot adjusted legend\n        legend(par('usr')[2], par('usr')[4],\n               bty = 'n', xpd = NA,\n               legend = le$le[le$i],\n               lty = le$lt[le$i],\n               col = le$co[le$i])\n\n        ## add some info to plot\n        mtext('Bias', side = 3, adj = 0, line = 0.5, cex = 1.2)\n        mtext(paste0('File: ', fi), side = 1, adj = 0, line = 4)\n\n      } else {\n        plot.new()\n      }\n    } else {\n      plot.new()\n    }\n  })\n  \n  ## reset and stop plotting on any input change\n  observeEvent(list(input$folderpath, input$model, input$variable, input$numindividuals,\n                    input$bali, input$setsd,\n                    input$wait, input$plotspecrep, input$plottype), {\n                      rv$stop <- TRUE\n                      rv$i <- 0\n                      rv$eff <- list()\n                      rv$bias <- list()\n                    }, ignoreInit = TRUE)\n  \n  observeEvent(input$plottype, {\n    updateCheckboxInput(session, \"plotspecrep\", value = FALSE)\n    rv$stop <- TRUE\n    rv$i <- 0\n    rv$eff <- list()\n    rv$bias <- list()\n  }, ignoreInit = TRUE)\n  \n  ## start plotting if plot button is pressed\n  observeEvent(input$startplot, {\n    rv$stop <- FALSE\n    rv$i <- 0\n    rv$eff <- list()\n    rv$bias <- list()\n    observe({\n      isolate({rv$i <- rv$i + 1})\n      if(input$plottype == \"Separate\" & input$plotspecrep) {\n        rv$i <- input$specrep\n        invalidateLater(input$wait * 700, session)\n      } else if (isolate(rv$i) < maxiter && !isolate(rv$stop)) {\n        invalidateLater(input$wait * 700, session)\n      }\n    })\n  }, ignoreInit = TRUE)\n  \n}\n\nshinyApp(ui, server)","type":"text"}]
